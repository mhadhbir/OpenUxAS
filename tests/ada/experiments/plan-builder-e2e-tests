#! /usr/bin/env bash

# Script location
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"

# Load global paths
source "${SCRIPT_DIR}/../../../infrastructure/paths.sh"

# Create the bin directory
mkdir -p "${SCRIPT_DIR}/bin"

# Build the C++ tests
(
    cd "${OPENUXAS_ROOT}"
    make test -j
    mv test-uxas "${SCRIPT_DIR}/bin"
)

# Create the output directory
mkdir -p "${SCRIPT_DIR}/output"

# Run the C++ tests
(
    cd "${SCRIPT_DIR}/output"
    "${SCRIPT_DIR}/bin/test-uxas"
)


# Build the Ada tests
(
    ensure_gnat
    debug_and_run "eval \"\$( \"${OPENUXAS_ROOT}/anod\" printenv uxas-ada --build-env )\""
    cd "${SCRIPT_DIR}/ada"
    gprbuild -P proj.gpr
)

# Run the Ada tests
(
    cd "${SCRIPT_DIR}/output"
    "${SCRIPT_DIR}/bin/main_ada"
)


# Run the comparison
activate_venv

echo "TODO: add python call to compare the C++ and Ada test results"
# e.g.:
#   python3 "${SCRIPT_DIR}/diff.py"
# with appropriate argument handling in the python
